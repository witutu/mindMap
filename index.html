<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>ÊÄùÁª¥ÂØºÂõæ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'">
    <link rel="stylesheet" href="./jsmind.css">
    <script src="./jsmind.js"></script>
    <script src="./hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script type="text/javascript" src="https://gitcode.net/dcloud/uni-app/-/raw/dev/dist/uni.webview.1.5.6.js"></script>

    <style>
        :root {
            --primary-bg: #f4f4f4;
            --menu-bg: white;
            --menu-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            --menu-border: #eee;
            --menu-hover: #f5f5f5;
            --loading-bg: rgba(0, 0, 0, 0.7);
            --text-color: #333;
            --menu-item-size: 28px;
            --menu-z-index: 1000;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: none;
            background: var(--primary-bg);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #jsmind_container {
            width: 100vw;
            height: 100vh;
            touch-action: none;
            padding-bottom: 65px;
            padding-top: 24px;
            box-sizing: border-box;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--loading-bg);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            z-index: var(--menu-z-index);
            transition: opacity 0.3s ease;
        }

        .node-menu {
            position: fixed;
            background: var(--menu-bg);
            border-radius: 4px;
            box-shadow: var(--menu-shadow);
            display: none;
            z-index: var(--menu-z-index);
            padding: 5px;
            flex-direction: row;
            user-select: none;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .node-menu.show {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        .node-menu-item {
            padding: 6px 10px;
            cursor: pointer;
            white-space: nowrap;
            font-size: var(--menu-item-size);
            color: var(--text-color);
            display: flex;
            align-items: center;
            margin: 0 2px;
            border-radius: 3px;
            transition: background-color 0.2s ease;
        }

        .node-menu-item:hover {
            background-color: var(--menu-hover);
        }

        .node-menu-item + .node-menu-item {
            border-left: 1px solid var(--menu-border);
            margin-left: 5px;
            padding-left: 5px;
        }

        .node-menu-item i {
            margin-right: 5px;
            font-size: var(--menu-item-size);
        }

        .error-message {
            color: #ff6b6b;
            font-weight: bold;
        }

        /* È°∂ÈÉ®Êìç‰Ωú */
        .top-buttons {
            position: fixed;
            z-index: var(--menu-z-index);
            display: flex;
            top: 0;
            width: 100%;
            background-color: #f4f4f4;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.15);
            padding: 10px;
            justify-content: right;
        }

        .top-button {
            width: 24px;
            height: 24px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        /* Â∑¶‰∏ãËßíÊåâÈíÆÁªÑ */
        .bottom-buttons {
            position: fixed;
            z-index: var(--menu-z-index);
            display: flex;
            bottom: 0;
            width: 100%;
            background-color: #f4f4f4;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.15);
            padding: 10px;
            gap: 20px;
            justify-content: right;
        }

        .bottom-button {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            /* background: var(--menu-bg); */
            border: none;
            box-shadow: var(--menu-shadow);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: bold;
            line-height: 1;
            transition: all 0.2s ease;
            user-select: none;
            touch-action: manipulation;
        }

        /* .bottom-button:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .bottom-button:active:not(:disabled) {
            transform: scale(0.95);
        } */

        .bottom-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .bottom-button.sibling {
            color: white;
        }

        /* .bottom-button.sibling:hover:not(:disabled) {
            background: #F57C00;
        } */

        .bottom-button.child {
            color: white;
        }

        /* .bottom-button.child:hover:not(:disabled) {
            background: #1976D2;
        } */

        .show-expand-type {
            display: none;
            position: fixed;
            z-index: 1001;
            bottom: 0;
            width: 100%;
            background-color: #f4f4f4;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.15);
            padding: 20px;
            border-radius: 20px 20px 0 0;
            color: #292929;
        }

        .show-expand-type .showtitle {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .show-expand-type .showTypeTitle {
            font-size: 18px;
            font-weight: bold;
            margin-right: 10px;
        }

        .show-expand-type .iconSvg {
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .show-expand-type .showTypeContent {
            background-color: #fff;
            border-radius: 20px;
            font-size: 18px;
        }

        .show-expand-type .showTypeItem {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
        }

        .show-expand-type .line {
            width: 100%;
            height: 1px;
            background-color: #e0e0e0;
        }
    </style>
</head>
<body>
    <div id="loading">Ê≠£Âú®Ê∏≤ÊüìÊÄùÁª¥ÂØºÂõæ...</div>
    <div class="top-buttons">
        <div class="top-button" id="expandAllBtn">
            <svg t="1752630957149" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="944" width="200" height="200"><path d="M512 640.64a42.666667 42.666667 0 0 0 42.666667-42.666667v-341.333333h130.986666a21.333333 21.333333 0 0 0 14.250667-5.461333l2.688-2.901334a21.333333 21.333333 0 0 0-4.010667-29.909333l-165.717333-126.464a32 32 0 0 0-38.912 0.042667L329.472 218.453333a21.333333 21.333333 0 0 0 12.970667 38.229334H469.333333v341.333333a42.666667 42.666667 0 0 0 42.666667 42.666667z m229.674667-298.368a42.666667 42.666667 0 0 0 4.992 85.034667H853.333333v426.666666H170.666667v-426.666666h106.666666a42.666667 42.666667 0 0 0 0-85.333334H170.666667a85.333333 85.333333 0 0 0-85.333334 85.333334v426.666666a85.333333 85.333333 0 0 0 85.333334 85.333334h682.666666a85.333333 85.333333 0 0 0 85.333334-85.333334v-426.666666a85.333333 85.333333 0 0 0-85.333334-85.333334h-106.666666z" fill="#000000" p-id="945"></path></svg>
        </div>
    </div>
    <div id="jsmind_container"></div>
    
    <div class="node-menu" id="nodeMenu">
        <div class="node-menu-item" id="addChildNode" data-action="add">
            <i>‚ûï</i> Êñ∞Â¢û
        </div>
        <div class="node-menu-item" id="editNode" data-action="edit">
            <i>‚úèÔ∏è</i> ÁºñËæë
        </div>
        <div class="node-menu-item" id="deleteNode" data-action="delete">
            <i>üóëÔ∏è</i> Âà†Èô§
        </div>
    </div>

    <!-- Â∑¶‰∏ãËßíÊåâÈíÆÁªÑ -->
    <div class="bottom-buttons">
        <button class="bottom-button sibling" id="addSiblingBtn" title="Ê∑ªÂä†ÂÖÑÂºüËäÇÁÇπÔºàÂêåÁ∫ßËäÇÁÇπÔºâ">
            <svg t="1752627873304" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1507" width="200" height="200"><path d="M672 432c-120.3 0-219.9 88.5-237.3 204H320c-15.5 0-28-12.5-28-28V244h291c14.2 35.2 48.7 60 89 60 53 0 96-43 96-96s-43-96-96-96c-40.3 0-74.8 24.8-89 60H112v72h108v364c0 55.2 44.8 100 100 100h114.7c17.4 115.5 117 204 237.3 204 132.5 0 240-107.5 240-240S804.5 432 672 432z m128 266c0 4.4-3.6 8-8 8h-86v86c0 4.4-3.6 8-8 8h-52c-4.4 0-8-3.6-8-8v-86h-86c-4.4 0-8-3.6-8-8v-52c0-4.4 3.6-8 8-8h86v-86c0-4.4 3.6-8 8-8h52c4.4 0 8 3.6 8 8v86h86c4.4 0 8 3.6 8 8v52z" p-id="1508"></path></svg>
        </button>
        <button class="bottom-button child" id="addChildBtn" title="Ê∑ªÂä†Â≠êËäÇÁÇπÔºà‰∏ãÁ∫ßËäÇÁÇπÔºâ">
            <svg t="1752627743421" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1193" width="200" height="200"><path d="M688 240c-138 0-252 102.8-269.6 236H249c-14.2-35.2-48.7-60-89-60-53 0-96 43-96 96s43 96 96 96c40.3 0 74.8-24.8 89-60h169.3C436 681.2 550 784 688 784c150.2 0 272-121.8 272-272S838.2 240 688 240z m128 298c0 4.4-3.6 8-8 8h-86v86c0 4.4-3.6 8-8 8h-52c-4.4 0-8-3.6-8-8v-86h-86c-4.4 0-8-3.6-8-8v-52c0-4.4 3.6-8 8-8h86v-86c0-4.4 3.6-8 8-8h52c4.4 0 8 3.6 8 8v86h86c4.4 0 8 3.6 8 8v52z" p-id="1194"></path></svg>
        </button>
    </div>

    <div class="show-expand-type">
        <div class="showtitle">
            <div class="showTypeTitle">ÂØºÂá∫‰∏∫</div>
            <div class="showTypeClose iconSvg" id="closeShowType"><svg t="1752632412129" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="974" width="200" height="200"><path d="M666.17 716.5c-7.73 0-15.46-2.95-21.36-8.85L336.47 399.31c-11.8-11.8-11.8-30.92 0-42.72s30.92-11.8 42.72 0l308.35 308.35c11.8 11.8 11.8 30.92 0 42.72a30.184 30.184 0 0 1-21.37 8.84z" p-id="975"></path><path d="M357.83 716.5c-7.73 0-15.46-2.95-21.36-8.85-11.8-11.8-11.8-30.92 0-42.72l308.35-308.35c11.8-11.8 30.92-11.8 42.72 0s11.8 30.92 0 42.72L379.19 707.65c-5.9 5.9-13.63 8.85-21.36 8.85z" p-id="976"></path><path d="M512 945C273.25 945 79 750.76 79 512S273.25 79 512 79s433 194.24 433 433-194.25 433-433 433z m0-805.58c-205.45 0-372.58 167.13-372.58 372.58S306.55 884.58 512 884.58 884.58 717.45 884.58 512 717.45 139.42 512 139.42z" p-id="977"></path></svg></div>
        </div>
        <div class="showTypeContent">
            <div class="showTypeItem" data-type="pdf">
                PDF
                <div class="iconSvg">
                    <svg t="1752633666538" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1065" width="200" height="200"><path d="M875.1 301.8L597.3 21.3c-4.5-4.5-9.4-8.3-14.7-11.5-1.4-0.8-2.8-1.6-4.3-2.3-0.9-0.5-1.9-0.9-2.8-1.3-9-4-18.9-6.2-29-6.2h-345c-39.8 0-73 32.2-73 72v880c0 39.8 33.2 72 73 72h623c39.8 0 71-32.2 71-72V352.5c0-19-7-37.2-20.4-50.7zM583.5 110.4L784.3 312H583.5V110.4z m240 841.6h-623V72h311v240c0 39.8 33.2 72 73 72h239v568z" fill="#040000" p-id="1066"></path><path d="M333.2 576h-66.7v192h46v-64h22.1c40.4 0 75.6-20.2 75.6-65.7-0.1-47.3-34.7-62.3-77-62.3z m-0.9 92h-19.8v-56H331c22.2 0 34.5 7 34.5 26.4 0 18.7-10.8 29.6-33.2 29.6zM498 576h-55.5v192h58.1c55.8 0 94.4-30.4 94.4-97s-38.6-95-97-95z m-2.9 155h-5.6V613h5.6c30.9 0 52.7 12.8 52.7 58.3S526 731 495.1 731zM752.5 614v-38h-122v192h46v-73h65v-38h-65v-43z" fill="#040000" p-id="1067"></path></svg>
                </div>
            </div>
            <div class="line"></div>
            <div class="showTypeItem" data-type="image">  
                ÊÄùÁª¥ÂØºÂõæÂõæÁâá
                <div class="iconSvg">
                    <svg t="1752633693004" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1227" width="200" height="200"><path d="M659.4 311.8h225.2c10 0 18-8 18-18V181c0-10-8-18-18-18H659.4c-10 0-18 8-18 18v46.6h-50.2c-48.6 0-88 39.4-88 88V432c0 39.8-32.2 72-72 72h-49c-4-37.2-35.6-66.4-73.8-66.4H195.8c-41 0-74.4 33.4-74.4 74.4s33.4 74.4 74.4 74.4h112.4c38.2 0 69.8-29 73.8-66.4h49c39.8 0 72 32.2 72 72v116.4c0 48.6 39.4 88 88 88h50.2v50.4c0 10 8 18 18 18h225.2c10 0 18-8 18-18v-112.6c0-10-8-18-18-18H659.4c-10 0-18 8-18 18v46.2h-50.2c-39.8 0-72-32.2-72-72V592c0-29.8-14.8-56-37.4-72h159.6v48.4c0 10 8 18 18 18h225.2c10 0 18-8 18-18v-112.6c0-10-8-18-18-18H659.4c-10 0-18 8-18 18V504h-159.6c22.6-16 37.4-42.2 37.4-72v-116.4c0-39.8 32.2-72 72-72h50.2v50.2c0 9.8 8 18 18 18z" fill="#212930" p-id="1228"></path></svg>
                </div>
            </div>
        </div>
    </div>

    <script>
        'use strict';

        // ÈÖçÁΩÆÂ∏∏Èáè
        const CONFIG = {
            SCALE: {
                MIN: 0.5,
                MAX: 2,
                DEFAULT: 1
            },
            TIMINGS: {
                DOUBLE_CLICK: 300,
                MENU_DELAY: 200,
                LOADING_HIDE: 300,
                RETRY_DELAY: 100,
                UPDATE_INTERVAL: 100
            },
            MENU: {
                OFFSET: 10,
                MIN_DISTANCE: 10,
                DEFAULT_WIDTH: 150,
                DEFAULT_HEIGHT: 60
            },
            DRAG: {
                THRESHOLD: 5  // ÊãñÊãΩÊ£ÄÊµãÈòàÂÄºÔºàÂÉèÁ¥†Ôºâ
            },
            API: {
                BASE_URL: 'https://www.zxsl.zxmap.cn/ai-api/business/aiTask/',
                DEFAULT_ID: '1927009104298840066'
            }
        };

        // Â∫îÁî®Áä∂ÊÄÅÁÆ°ÁêÜ
        class AppState {
            constructor() {
                this.jm = null;
                this.currentScale = CONFIG.SCALE.DEFAULT;
                this.selectedNode = null;
                this.lastClickTime = 0;
                this.isDoubleClicking = false;
                this.menuVisible = false;
                this.currentNodeClickPosition = { x: 0, y: 0, nodeId: null };
                this.menuUpdateTimer = null;
                this.elements = {};
                this.suppressMenuOnce = false;
            }

            initElements() {
                this.elements = {
                    loading: document.getElementById('loading'),
                    container: document.getElementById('jsmind_container'),
                    nodeMenu: document.getElementById('nodeMenu'),
                    addChildNode: document.getElementById('addChildNode'),
                    editNode: document.getElementById('editNode'),
                    deleteNode: document.getElementById('deleteNode'),
                    addSiblingBtn: document.getElementById('addSiblingBtn'),
                    addChildBtn: document.getElementById('addChildBtn'),
                    expandAllBtn: document.getElementById('expandAllBtn'),
                    showExpandType: document.querySelector('.show-expand-type'),
                    closeShowType: document.getElementById('closeShowType')
                };
            }

            setCurrentNodeClickPosition(position) {
                this.currentNodeClickPosition = { ...position };
            }

            clearCurrentNodeClickPosition() {
                this.currentNodeClickPosition = { x: 0, y: 0, nodeId: null };
            }

            setMenuVisible(visible) {
                this.menuVisible = visible;
                if (visible) {
                    this.elements.nodeMenu.classList.add('show');
                } else {
                    this.elements.nodeMenu.classList.remove('show');
                }
            }
        }

        // Â∑•ÂÖ∑ÂáΩÊï∞
        const Utils = {
            getQueryParam(name) {
                const search = new URLSearchParams(location.search);
                return search.get(name);
            },

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            throttle(func, limit) {
                let inThrottle;
                return function(...args) {
                    if (!inThrottle) {
                        func.apply(this, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            },

            clamp(value, min, max) {
                return Math.min(Math.max(value, min), max);
            },

            hideElement(element, delay = 0) {
                setTimeout(() => {
                    if (element) {
                        element.style.display = 'none';
                    }
                }, delay);
            },

            showErrorMessage(message) {
                const loading = appState.elements.loading;
                if (loading) {
                    loading.innerHTML = `<span class="error-message">${message}</span>`;
                }
            }
        };

        // Êï∞ÊçÆËé∑ÂèñÊ®°Âùó
        class DataManager {
            static async fetchMindData() {
                try {
                    const id = Utils.getQueryParam('data') || CONFIG.API.DEFAULT_ID;
                    console.log('Ëé∑ÂèñÊï∞ÊçÆID:', id);
                    
                    const url = `${CONFIG.API.BASE_URL}${id}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`HTTPÈîôËØØ: ${response.status}`);
                    }
                    
                    const resJson = await response.json();
                    console.log('APIÂìçÂ∫î:', resJson);
                    
                    if (!resJson.data?.taskMindXxcMap) {
                        throw new Error("Êï∞ÊçÆÊ†ºÂºèÈîôËØØ");
                    }
                
                const data = JSON.parse(resJson.data.taskMindXxcMap);

                    if (!data) {
                        throw new Error("Êï∞ÊçÆ‰∏∫Á©∫");
                    }

                const mind = {
                    meta: { name: "ÊÄùÁª¥ÂØºÂõæ", author: "Á≥ªÁªü", version: "1.0" },
                    format: "node_tree",
                    data: data
                };

                    MindMapManager.init(mind);
            } catch (err) {
                    console.error("Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:", err);
                    Utils.showErrorMessage("‚ùå Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•");
                }
            }
        }

        // ÊÄùÁª¥ÂØºÂõæÁÆ°ÁêÜÊ®°Âùó
        class MindMapManager {
            static init(mind) {
                try {
            const options = { 
                container: 'jsmind_container', 
                editable: true, 
                theme: 'primary'
            };
            
                    appState.jm = jsMind.show(options, mind);
                    appState.jm.view.setZoom(CONFIG.SCALE.DEFAULT);

                    Utils.hideElement(appState.elements.loading, CONFIG.TIMINGS.LOADING_HIDE);
                    
                    NodeEditor.init();
                    TouchManager.init();
                    
                    // ÂàùÂßãÂåñÊåâÈíÆÁä∂ÊÄÅ
                    NodeEditor.updateBottomButtonsState();
                } catch (err) {
                    console.error("ÊÄùÁª¥ÂØºÂõæÂàùÂßãÂåñÂ§±Ë¥•:", err);
                    Utils.showErrorMessage("‚ùå ÊÄùÁª¥ÂØºÂõæÂàùÂßãÂåñÂ§±Ë¥•");
                }
            }
        }

        // ËäÇÁÇπÁºñËæëÂô®Ê®°Âùó
        class NodeEditor {
            static init() {
                this.bindEvents();
                this.initMenuEvents();
            }

            static bindEvents() {
                // ËäÇÁÇπÁÇπÂáª‰∫ã‰ª∂
                appState.elements.container.addEventListener('mousedown', this.handleMouseDown.bind(this), true);
                
                // jsMind‰∫ã‰ª∂ÁõëÂê¨
                appState.jm.add_event_listener(this.handleJsMindEvent.bind(this));
                
                // ÁîªÂ∏ÉÁÇπÂáª‰∫ã‰ª∂
                appState.elements.container.addEventListener('click', this.handleCanvasClick.bind(this));
                
                // Á™óÂè£Â§ßÂ∞èÂèòÂåñ‰∫ã‰ª∂
                window.addEventListener('resize', Utils.debounce(this.updateMenuPosition.bind(this), 100));
                
                // ÂÖ®Â±ÄÁÇπÂáª‰∫ã‰ª∂
                document.addEventListener('click', this.handleDocumentClick.bind(this));
                
                // Èº†Ê†áÊãñÊãΩ‰∫ã‰ª∂ - ÈöêËóèËèúÂçï
                appState.elements.container.addEventListener('mousemove', this.handleMouseMove.bind(this));
                
                // ÊªöËΩÆÁº©Êîæ‰∫ã‰ª∂ - ÈöêËóèËèúÂçï
                document.addEventListener('wheel', this.handleWheel.bind(this));
                
                // Ëß¶Êë∏ÁßªÂä®‰∫ã‰ª∂ - ÈöêËóèËèúÂçï
                appState.elements.container.addEventListener('touchmove', this.handleTouchMove.bind(this));
                
                // Ëß¶Êë∏ÂºÄÂßã‰∫ã‰ª∂ - ËÆ∞ÂΩïËß¶Êë∏‰ΩçÁΩÆ
                appState.elements.container.addEventListener('touchstart', this.handleTouchStart.bind(this));
                
                // Èº†Ê†áÈáäÊîæ‰∫ã‰ª∂ - Ê∏ÖÁêÜÊãñÊãΩÁä∂ÊÄÅ
                document.addEventListener('mouseup', this.handleMouseUp.bind(this));
                
                // Ëß¶Êë∏ÁªìÊùü‰∫ã‰ª∂ - Ê∏ÖÁêÜËß¶Êë∏Áä∂ÊÄÅ
                document.addEventListener('touchend', this.handleTouchEnd.bind(this));
                
                // Â∫ïÈÉ®ÊåâÈíÆ‰∫ã‰ª∂
                this.bindBottomButtons();

                // È°∂ÈÉ®ÊåâÈíÆ‰∫ã‰ª∂
                this.bindTopButtons();
            }

            static bindTopButtons() {
                appState.elements.expandAllBtn.addEventListener('click', this.handleExpandAll.bind(this));
                appState.elements.closeShowType.addEventListener('click', ()=>{
                    appState.elements.showExpandType.style.display = 'none';
                });

                const items = document.querySelectorAll('.showTypeItem');
                items.forEach(item => {
                    item.addEventListener('click', this.handleExportTypeClick.bind(this));
                });
            }

            static initMenuEvents() {
                // ËèúÂçïÈ°πÁÇπÂáª‰∫ã‰ª∂
                appState.elements.nodeMenu.addEventListener('click', this.handleMenuClick.bind(this));
                
                // ÈòªÊ≠¢ËèúÂçï‰∫ã‰ª∂ÂÜíÊ≥°
                appState.elements.nodeMenu.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }

            static bindBottomButtons() {
                // Ê∑ªÂä†ÂÖÑÂºüËäÇÁÇπÊåâÈíÆ
                appState.elements.addSiblingBtn.addEventListener('click', this.handleAddSibling.bind(this));
                
                // Ê∑ªÂä†Â≠êËäÇÁÇπÊåâÈíÆ
                appState.elements.addChildBtn.addEventListener('click', this.handleAddChild.bind(this));
                
                // ÂàùÂßãÂåñÊåâÈíÆÁä∂ÊÄÅ
                this.updateBottomButtonsState();
            }

            static handleMouseDown(e) {
                const clickPosition = {
                    x: e.clientX,
                    y: e.clientY,
                    width: e.target.offsetWidth,
                    height: e.target.offsetHeight
                };
                
                // Â≠òÂÇ®ÁÇπÂáª‰ΩçÁΩÆÔºåÁî®‰∫éÂêéÁª≠ËèúÂçïÊòæÁ§∫
                this.lastClickPosition = clickPosition;
                
                // Â≠òÂÇ®Èº†Ê†áÊåâ‰∏ãÁöÑÂàùÂßã‰ΩçÁΩÆÔºåÁî®‰∫éÊ£ÄÊµãÊãñÊãΩ
                this.mouseDownPosition = {
                    x: e.clientX,
                    y: e.clientY,
                    time: Date.now()
                };
            }

            static handleJsMindEvent(type, data) {
                if (data.evt === 'select_node') {
                    this.handleNodeSelect();
                } else if (data.evt === 'dblclick_node') {
                    this.hideMenu();
                } else if (type === 'click_on_canvas') {
                    this.hideMenu();
                }
                
                // ‰ªª‰ΩïËäÇÁÇπÊìç‰ΩúÂêéÈÉΩÊõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
                this.updateBottomButtonsState();
            }

            static handleNodeSelect() {
                const selectedNode = appState.jm.get_selected_node();
                if (!selectedNode || !this.lastClickPosition) return;

                appState.selectedNode = selectedNode;

                if (appState.suppressMenuOnce) {
                    // Ë∑≥ËøáËèúÂçïÊòæÁ§∫ÔºåÂè™ÂÅöÈÄâ‰∏≠
                    appState.suppressMenuOnce = false;
                    this.updateBottomButtonsState();
                    return;
                }
                
                appState.setCurrentNodeClickPosition({
                    x: this.lastClickPosition.x,
                    y: this.lastClickPosition.y,
                    width: this.lastClickPosition.width,
                    height: this.lastClickPosition.height,
                    nodeId: selectedNode.id
                });

                this.showMenuAtPosition(this.lastClickPosition.x, this.lastClickPosition.y);
                
                // Êõ¥Êñ∞Â∫ïÈÉ®ÊåâÈíÆÁä∂ÊÄÅ
                this.updateBottomButtonsState();
            }

            static showMenuAtPosition(x, y) {
                const menu = appState.elements.nodeMenu;
                const menuWidth = menu.offsetWidth || CONFIG.MENU.DEFAULT_WIDTH;
                const menuHeight = menu.offsetHeight || CONFIG.MENU.DEFAULT_HEIGHT;
                
                let left = x - (menuWidth / 2);
                let top = y - menuHeight - CONFIG.MENU.OFFSET;

                // ËæπÁïåÊ£ÄÊü•
                if (top < CONFIG.MENU.MIN_DISTANCE) {
                    top = y + CONFIG.MENU.OFFSET;
                }
                if (left < CONFIG.MENU.MIN_DISTANCE) {
                    left = CONFIG.MENU.MIN_DISTANCE;
                }
                if (left > window.innerWidth - menuWidth - CONFIG.MENU.MIN_DISTANCE) {
                    left = window.innerWidth - menuWidth - CONFIG.MENU.MIN_DISTANCE;
                }

                menu.style.left = left + 'px';
                menu.style.top = top + 'px';
                
                appState.setMenuVisible(true);
                this.startMenuTracking();
            }

            static startMenuTracking() {
                if (appState.menuUpdateTimer) {
                    clearInterval(appState.menuUpdateTimer);
                }
                
                appState.menuUpdateTimer = setInterval(() => {
                    if (appState.menuVisible && appState.selectedNode) {
                        this.updateMenuPosition();
                    } else {
                        this.stopMenuTracking();
                    }
                }, CONFIG.TIMINGS.UPDATE_INTERVAL);
            }

            static stopMenuTracking() {
                if (appState.menuUpdateTimer) {
                    clearInterval(appState.menuUpdateTimer);
                    appState.menuUpdateTimer = null;
                }
            }

            static updateMenuPosition() {
                if (!appState.selectedNode || !appState.menuVisible) return;

                const nodeElement = this.findNodeElement(appState.selectedNode.id);
                if (!nodeElement) return;

                const rect = nodeElement.getBoundingClientRect();
                if (rect.width === 0 && rect.height === 0) {
                    setTimeout(() => this.updateMenuPosition(), CONFIG.TIMINGS.RETRY_DELAY);
                    return;
                }

                const menu = appState.elements.nodeMenu;
                const menuWidth = menu.offsetWidth || CONFIG.MENU.DEFAULT_WIDTH;
                const menuHeight = menu.offsetHeight || CONFIG.MENU.DEFAULT_HEIGHT;
                
                let left = appState.currentNodeClickPosition.x - (menuWidth / 2);
                let top = appState.currentNodeClickPosition.y - menuHeight - CONFIG.MENU.OFFSET;

                // ËæπÁïåÊ£ÄÊü•
                if (top < CONFIG.MENU.MIN_DISTANCE) {
                    top = appState.currentNodeClickPosition.y + CONFIG.MENU.OFFSET;
                }
                if (left < CONFIG.MENU.MIN_DISTANCE) {
                    left = CONFIG.MENU.MIN_DISTANCE;
                }

                menu.style.left = left + 'px';
                menu.style.top = top + 'px';
            }

            static findNodeElement(nodeId) {
                const selectors = [
                    `[nodeid="${nodeId}"]`,
                    `#${nodeId}`,
                    `jmnode[nodeid="${nodeId}"]`
                ];
                
                for (const selector of selectors) {
                    const element = document.querySelector(selector);
                    if (element) return element;
                }
                
                // Â§áÈÄâÊñπÊ°àÔºöÈÅçÂéÜÊâÄÊúâËäÇÁÇπ
                const allNodes = document.querySelectorAll('jmnode');
                for (const node of allNodes) {
                    if (node.getAttribute('nodeid') === nodeId) {
                        return node;
                    }
                }
                
                return null;
            }

            static handleCanvasClick(e) {
                if (!e.target.closest('jmnode') && !e.target.closest('.node-menu') && !e.target.closest('.bottom-buttons')) {
                    this.hideMenu();
                    appState.clearCurrentNodeClickPosition();
                    appState.selectedNode = null;
                    this.updateBottomButtonsState();
                }
            }

            static handleDocumentClick() {
                if (appState.menuVisible) {
                    this.hideMenu();
                }
            }

            static handleMouseMove(e) {
                // Ê£ÄÊµãÊòØÂê¶ÊòØÊãñÊãΩÊìç‰ΩúÔºàÈº†Ê†áÊåâ‰∏ãÊó∂ÁßªÂä®Ôºâ
                if (e.buttons > 0) {
                    // Â¶ÇÊûúÊúâmouseDownPositionÔºåÊ£ÄÊµãÊòØÂê¶ÂºÄÂßãÊãñÊãΩ
                    if (this.mouseDownPosition) {
                        const deltaX = Math.abs(e.clientX - this.mouseDownPosition.x);
                        const deltaY = Math.abs(e.clientY - this.mouseDownPosition.y);
                        const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                        
                        // Â¶ÇÊûúÁßªÂä®Ë∑ùÁ¶ªË∂ÖËøáÈòàÂÄºÔºåËÆ§‰∏∫ÊòØÊãñÊãΩÊìç‰Ωú
                        if (distance > CONFIG.DRAG.THRESHOLD) {
                            if (appState.menuVisible) {
                                this.hideMenu();
                            }
                            // Ê∏ÖÈô§mouseDownPositionÔºåÈÅøÂÖçÈáçÂ§çÊ£ÄÊµã
                            this.mouseDownPosition = null;
                        }
                    } else if (appState.menuVisible) {
                        // Â¶ÇÊûúÊ≤°ÊúâmouseDownPosition‰ΩÜÈº†Ê†áÊåâ‰∏ãÔºåÁõ¥Êé•ÈöêËóèËèúÂçï
                        this.hideMenu();
                    }
                }
            }

            static handleWheel(e) {
                // ÊªöËΩÆÁº©ÊîæÊó∂ÈöêËóèËèúÂçï
                if (appState.menuVisible) {
                    this.hideMenu();
                }
            }

            static handleTouchStart(e) {
                // Â≠òÂÇ®Ëß¶Êë∏ÂºÄÂßã‰ΩçÁΩÆ
                if (e.touches.length === 1) {
                    this.touchStartPosition = {
                        x: e.touches[0].clientX,
                        y: e.touches[0].clientY,
                        time: Date.now()
                    };
                }
            }

            static handleTouchMove(e) {
                // Ê£ÄÊµãÊòØÂê¶ÊòØÊãñÊãΩÊìç‰Ωú
                if (e.touches.length === 1 && this.touchStartPosition) {
                    const deltaX = Math.abs(e.touches[0].clientX - this.touchStartPosition.x);
                    const deltaY = Math.abs(e.touches[0].clientY - this.touchStartPosition.y);
                    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                    
                    // Â¶ÇÊûúÁßªÂä®Ë∑ùÁ¶ªË∂ÖËøáÈòàÂÄºÔºåËÆ§‰∏∫ÊòØÊãñÊãΩÊìç‰Ωú
                    if (distance > CONFIG.DRAG.THRESHOLD && appState.menuVisible) {
                        this.hideMenu();
                    }
                } else if (appState.menuVisible) {
                    // Â§öÁÇπËß¶ÊéßÊó∂ÈöêËóèËèúÂçï
                    this.hideMenu();
                }
            }

            static handleMouseUp(e) {
                // Ê∏ÖÁêÜÊãñÊãΩÁä∂ÊÄÅ
                this.mouseDownPosition = null;
            }

            static handleTouchEnd(e) {
                // Ê∏ÖÁêÜËß¶Êë∏Áä∂ÊÄÅ
                this.touchStartPosition = null;
            }

            static hideMenu() {
                appState.setMenuVisible(false);
                appState.selectedNode = null;
                this.stopMenuTracking();
                
                // Êõ¥Êñ∞Â∫ïÈÉ®ÊåâÈíÆÁä∂ÊÄÅ
                this.updateBottomButtonsState();
            }

            static handleMenuClick(e) {
                const item = e.target.closest('.node-menu-item');
                if (!item || !appState.selectedNode) return;

                const action = item.dataset.action;
                
                switch (action) {
                    case 'add':
                        this.addChildNode();
                        break;
                    case 'edit':
                        this.editNode();
                        break;
                    case 'delete':
                        this.deleteNode();
                        break;
                }
                
                this.hideMenu();
            }

            static addChildNode() {
                const newNodeId = 'node_' + Date.now();
                const newTopic = 'Êñ∞ËäÇÁÇπ';
                appState.jm.add_node(appState.selectedNode, newNodeId, newTopic);
                
                // ÈÄâ‰∏≠Êñ∞ÂàõÂª∫ÁöÑËäÇÁÇπÂπ∂ÂºÄÂßãÁºñËæë
                setTimeout(() => {
                    const newNode = appState.jm.get_node(newNodeId);
                    if (newNode) {
                        appState.jm.select_node(newNode);
                        // Ëá™Âä®ÂºÄÂßãÁºñËæëÊ®°Âºè
                        setTimeout(() => {
                            appState.jm.begin_edit(newNode);
                        }, 100);
                    }
                }, 100);
            }

            static editNode() {
                const currentTopic = appState.selectedNode.topic;
                const newTopic = prompt('ËØ∑ÁºñËæëËäÇÁÇπÂÜÖÂÆπ:', currentTopic);
                
                if (newTopic !== null && newTopic !== currentTopic) {
                    appState.jm.update_node(appState.selectedNode.id, newTopic);
                }
            }

            static deleteNode() {
                if (appState.selectedNode.id === 'root') {
                    alert('‰∏çËÉΩÂà†Èô§Ê†πËäÇÁÇπ');
                    return;
                }
                
                if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËØ•ËäÇÁÇπÂêóÔºüÂ≠êËäÇÁÇπ‰πüÂ∞ÜË¢´Âà†Èô§„ÄÇ')) {
                    appState.jm.remove_node(appState.selectedNode.id);
                }
            }

            static handleAddSibling(e) {
                if (e) e.stopPropagation();
                
                if (!appState.selectedNode) {
                    alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËäÇÁÇπ');
                    return;
                }
                
                if (appState.selectedNode.id === 'root') {
                    alert('Ê†πËäÇÁÇπ‰∏çËÉΩÊ∑ªÂä†ÂÖÑÂºüËäÇÁÇπ');
                    return;
                }
                
                const parentNode = appState.selectedNode.parent;
                if (!parentNode) {
                    alert('Êó†Ê≥ïÊâæÂà∞Áà∂ËäÇÁÇπ');
                    return;
                }
                appState.setMenuVisible(false);

                const newNodeId = 'node_' + Date.now();
                const newTopic = 'Êñ∞ÂÖÑÂºüËäÇÁÇπ';
                
                // Ê∑ªÂä†ÂÖÑÂºüËäÇÁÇπ
                appState.jm.add_node(parentNode, newNodeId, newTopic);
                
                // ÈÄâ‰∏≠Êñ∞ÂàõÂª∫ÁöÑËäÇÁÇπÂπ∂ÂºÄÂßãÁºñËæë
                setTimeout(() => {
                    const newNode = appState.jm.get_node(newNodeId);
                    if (newNode) {
                        appState.suppressMenuOnce = true;
                        appState.jm.select_node(newNode);
                        // Ëá™Âä®ÂºÄÂßãÁºñËæëÊ®°Âºè
                        setTimeout(() => {
                            appState.jm.begin_edit(newNode);
                        }, 100);
                    }
                }, 100);
            }

            static handleAddChild(e) {
                if (e) e.stopPropagation();
                
                // Â¶ÇÊûúÊ≤°ÊúâÈÄâ‰∏≠ËäÇÁÇπÔºåÈªòËÆ§ÈÄâÊã©Ê†πËäÇÁÇπ
                let targetNode = appState.selectedNode;
                if (!targetNode) {
                    targetNode = appState.jm.get_root();
                    if (!targetNode) {
                        alert('Êó†Ê≥ïËé∑ÂèñÊ†πËäÇÁÇπ');
                        return;
                    }
                }
                appState.setMenuVisible(false);
                const newNodeId = 'node_' + Date.now();
                const newTopic = 'Êñ∞Â≠êËäÇÁÇπ';
                
                // Ê∑ªÂä†Â≠êËäÇÁÇπ
                appState.jm.add_node(targetNode, newNodeId, newTopic);
                
                // ÈÄâ‰∏≠Êñ∞ÂàõÂª∫ÁöÑËäÇÁÇπÂπ∂ÂºÄÂßãÁºñËæë
                setTimeout(() => {
                    const newNode = appState.jm.get_node(newNodeId);
                    if (newNode) {
                        appState.suppressMenuOnce = true;
                        appState.jm.select_node(newNode);
                        // Ëá™Âä®ÂºÄÂßãÁºñËæëÊ®°Âºè
                        setTimeout(() => {
                            appState.jm.begin_edit(newNode);
                        }, 100);
                    }
                }, 100);
            }

            static updateBottomButtonsState() {
                const hasSiblingBtn = appState.elements.addSiblingBtn;
                const hasChildBtn = appState.elements.addChildBtn;
                
                if (!hasSiblingBtn || !hasChildBtn) return;
                
                if (!appState.selectedNode) {
                    // Ê≤°ÊúâÈÄâ‰∏≠ËäÇÁÇπÊó∂ÔºåÁ¶ÅÁî®ÂÖÑÂºüËäÇÁÇπÊåâÈíÆÔºåÂêØÁî®Â≠êËäÇÁÇπÊåâÈíÆÔºàÊ∑ªÂä†Âà∞Ê†πËäÇÁÇπÔºâ
                    hasSiblingBtn.disabled = true;
                    hasChildBtn.disabled = false;
                } else if (appState.selectedNode.id === 'root') {
                    // Ê†πËäÇÁÇπ‰∏çËÉΩÊ∑ªÂä†ÂÖÑÂºüËäÇÁÇπÔºå‰ΩÜÂèØ‰ª•Ê∑ªÂä†Â≠êËäÇÁÇπ
                    hasSiblingBtn.disabled = true;
                    hasChildBtn.disabled = false;
                } else {
                    // ÊôÆÈÄöËäÇÁÇπÂèØ‰ª•Ê∑ªÂä†ÂÖÑÂºüËäÇÁÇπÂíåÂ≠êËäÇÁÇπ
                    hasSiblingBtn.disabled = false;
                    hasChildBtn.disabled = false;
                }
            }

            static handleExpandAll() {
                const panel = appState.elements.showExpandType;
                if (panel) {
                    panel.style.display = 'block';
                }

                // ÁªëÂÆö‰∏ÄÊ¨°ÊÄßÁÇπÂáªÁõëÂê¨ÔºåÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠
                const handleOutsideClick = (e) => {
                    if (!panel.contains(e.target)) {
                        panel.style.display = 'none';
                        document.removeEventListener('click', handleOutsideClick);
                    }
                };

                // ‰ΩøÁî® setTimeout Á°Æ‰øùÁÇπÂáªÊåâÈíÆÊú¨Ë∫´‰∏çÁ´ãÂç≥Ëß¶Âèë
                setTimeout(() => {
                    document.addEventListener('click', handleOutsideClick);
                }, 0);
            }

            static handleExportTypeClick(e) {
                e.stopPropagation();

                const type = e.currentTarget.dataset.type;

                switch (type) {
                    case 'pdf':
                        NodeEditor.exportAsPDF();
                    break;
                    case 'image':
                        NodeEditor.exportAsImage();
                    break;
                    default:
                    console.warn('Êú™Áü•ÁöÑÂØºÂá∫Á±ªÂûã:', type);
                }

                // ÂØºÂá∫ÂêéÂÖ≥Èó≠Èù¢Êùø
                appState.elements.showExpandType.style.display = 'none';
            }

            static exportAsPDF() {
                console.log(11111111111111);
                if (!appState.jm) return;
                
                const mindData = appState.jm.get_data('node_tree');
                console.log('Âç≥Â∞ÜÂØºÂá∫ PDF:', mindData);

                // ËøôÈáåÂèØ‰ª•Ë∞ÉÁî® jsMind ÁöÑ API ÊàñËá™ÂÆö‰πâÈÄªËæë
                // Â¶ÇÊûúÊòØË¶ÅÂèëÁªôÂ∞èÁ®ãÂ∫èÔºåËµ∞ postMessage
                if (window.uni) {
                    uni.postMessage({
                        data: {
                            type: 'export',
                            format: 'pdf',
                            mindData: mindData
                        }
                    });
                } else {
                    console.log('Âú®ÊµèËßàÂô®‰∏≠ÔºöÊâßË°å PDF ÁîüÊàê...');
                    // ËøôÈáåÂèØ‰ª•Êé• PDF.js ÊàñË∞ÉÁî®ÂêéÁ´ØÁîüÊàê
                }
            }

            static exportAsImage() {
                try {
                    // 1Ô∏è‚É£ Â§á‰ªΩÊÄùÁª¥ÂØºÂõæÊï∞ÊçÆ
                    const mindData = appState.jm.get_data('node_tree');

                    // 2Ô∏è‚É£ ÂàõÂª∫ÈöêËóèÂÆπÂô®
                    const tempContainer = document.createElement('div');
                    tempContainer.style.position = 'absolute';
                    tempContainer.style.left = '-9999px';
                    tempContainer.style.top = '-9999px';
                    tempContainer.style.width = '3000px'; // Ë∂≥Â§üÂ§ß
                    tempContainer.style.height = '3000px';
                    tempContainer.style.background = '#fff'; // Èò≤Ê≠¢ÈÄèÊòé
                    document.body.appendChild(tempContainer);

                    // 3Ô∏è‚É£ Âú®‰∏¥Êó∂ÂÆπÂô®ÈáåÈáçÊñ∞Ê∏≤ÊüìÊÄùÁª¥ÂØºÂõæ
                    const options = {
                        container: tempContainer,
                        editable: false,
                        theme: 'primary'
                    };
                    const tempMind = jsMind.show(options, {
                        meta: { name: "MindMap", author: "export", version: "1.0" },
                        format: "node_tree",
                        data: mindData.data
                    });

                    // 4Ô∏è‚É£ Á≠âÂæÖ‰∏ÄÂ∏ßÔºåÁ°Æ‰øù DOM Ê∏≤ÊüìÂÆåÊØï
                    setTimeout(() => {
                        html2canvas(tempContainer, {
                            backgroundColor: '#ffffff',
                            useCORS: true
                    }).then(canvas => {
                        const imageBase64 = canvas.toDataURL('image/png');

                        // Â¶ÇÊûúÂú® uniapp ‰∏≠ÔºåÈÄöÁü•Â∞èÁ®ãÂ∫è
                        if (window.uni) {
                            uni.postMessage({
                                data: {
                                type: 'export',
                                format: 'image',
                                imageBase64: imageBase64
                                }
                            });
                        } else {
                            // Âê¶ÂàôÁõ¥Êé•‰∏ãËΩΩ
                            const link = document.createElement('a');
                            link.href = imageBase64;
                            link.download = 'mindmap_full.png';
                            link.click();
                        }

                        // ÁßªÈô§‰∏¥Êó∂ÂÆπÂô®
                        document.body.removeChild(tempContainer);
                    }).catch(err => {
                        console.error('ÂÖ®ÂõæÊà™ÂõæÂ§±Ë¥•:', err);
                        document.body.removeChild(tempContainer);
                    });
                    }, 100); // 100ms ËÆ© DOM ÊúâÊú∫‰ºöÊ∏≤ÊüìÂÆå
                } catch (err) {
                    console.error('ÂÖ®ÂõæÂØºÂá∫ÂºÇÂ∏∏:', err);
                }
            }

        }

        // Ëß¶Êë∏ÂíåÁº©ÊîæÁÆ°ÁêÜÊ®°Âùó
        class TouchManager {
            static init() {
                this.initHammer();
                this.bindTouchEvents();
            }

            static initHammer() {
                const hammer = new Hammer(appState.elements.container);
                hammer.get('pinch').set({ enable: true });
                
                let startScale = CONFIG.SCALE.DEFAULT;

                hammer.on('pinchstart', (e) => {
                e.preventDefault();
                    startScale = appState.currentScale;
                    
                    // ÂºÄÂßãÁº©ÊîæÊó∂ÈöêËóèËèúÂçï
                    if (appState.menuVisible) {
                        NodeEditor.hideMenu();
                    }
                });

                hammer.on('pinchmove', (e) => {
                e.preventDefault();
                    if (!appState.jm) return;

                    let newScale = startScale * e.scale;
                    newScale = Utils.clamp(newScale, CONFIG.SCALE.MIN, CONFIG.SCALE.MAX);
                    appState.jm.view.setZoom(newScale);

                    // Áº©ÊîæÊó∂ÈöêËóèËèúÂçï
                    if (appState.menuVisible) {
                        NodeEditor.hideMenu();
                    }
            });

                hammer.on('pinchend', (e) => {
                e.preventDefault();
                    if (!appState.jm) return;
                    
                    appState.currentScale *= e.scale;
                    appState.currentScale = Utils.clamp(appState.currentScale, CONFIG.SCALE.MIN, CONFIG.SCALE.MAX);
                    console.log('Áº©ÊîæÁªìÊùüÔºåÂΩìÂâçÊØî‰æã:', appState.currentScale);
                });
            }

            static bindTouchEvents() {
                // Èò≤Ê≠¢iOS SafariÈªòËÆ§ÂèåÊåáÁº©Êîæ
                document.addEventListener('gesturestart', (e) => {
                e.preventDefault();
            });

                // ÈòªÊ≠¢touchmoveÈÄ†ÊàêÊªöÂä®
                document.addEventListener('touchmove', (e) => {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
            }
        }

        // Â∫îÁî®Áä∂ÊÄÅÂÆû‰æã
        const appState = new AppState();

        // Â∫îÁî®ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            console.log(11111111111);
            appState.initElements();
            DataManager.fetchMindData();

            // ‚úÖ Âú®ÂàùÂßãÂåñÂêéÁõëÂê¨ UniAppJSBridgeReady
            document.addEventListener('UniAppJSBridgeReady', () => {
                console.log('‚úÖ UniAppJSBridge Â∑≤ÂáÜÂ§áÂ•ΩÔºÅ');
                window.uni = uni; // ÊåÇÂà∞ÂÖ®Â±Ä

                // üåü ‰Ω†ÂèØ‰ª•Âú®ËøôÈáåÊµãËØï‰∏ªÂä®ÂèëÁªôÂ∞èÁ®ãÂ∫è
                uni.postMessage({
                    data: {
                        type: 'init',
                        message: 'ÊÄùÁª¥ÂØºÂõæÂ∑≤Âä†ËΩΩ'
                    }
                });
            });
        });

        // ÈîôËØØÂ§ÑÁêÜ
        window.addEventListener('error', (e) => {
            console.error('ÂÖ®Â±ÄÈîôËØØ:', e.error);
            Utils.showErrorMessage('‚ùå Â∫îÁî®ÂèëÁîüÈîôËØØ');
        });

        // Êö¥Èú≤Âà∞ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºàÁî®‰∫éË∞ÉËØïÔºâ
        window.MindMapApp = {
            appState,
            Utils,
            DataManager,
            MindMapManager,
            NodeEditor,
            TouchManager
        };
    </script>
</body>
</html>
