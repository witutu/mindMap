<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>æ€ç»´å¯¼å›¾</title>
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'">
    <!-- <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsmind@0.8.7/style/jsmind.css" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jsmind@0.8.7/es6/jsmind.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script> -->
    <link rel="stylesheet" href="./jsmind.css">
    <script src="./jsmind.js"></script>
    <script src="./hammer.min.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; touch-action: none; /* é˜²æ­¢æ»šåŠ¨å¹²æ‰° */ background: #f4f4f4;}
        #jsmind_container { width: 100vw; height: 100vh; touch-action: none;}
        #loading {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white; padding: 10px 20px;
            border-radius: 8px; font-size: 16px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="loading">æ­£åœ¨æ¸²æŸ“æ€ç»´å¯¼å›¾...</div>
    <div id="jsmind_container"></div>

    <script>
       // è·å– query å‚æ•°
       function getQueryParam(name) {
            const search = new URLSearchParams(location.search);
            return search.get(name);
        }

        let jm = null; // **å­˜å‚¨ jsMind å®ä¾‹**
        let currentScale = 1; // **è®°å½•å½“å‰ç¼©æ”¾æ¯”ä¾‹**
        const minScale = 0.5;
        const maxScale = 2;

        // è·å–å°ç¨‹åºä¼ è¿‡æ¥çš„ id
        async function fetchMindData() {
            try {
                const id = getQueryParam('data') || "default";
                console.log('idï¼š', id);
                const res = await fetch(`https://www.zxsl.zxmap.cn/ai-api/business/aiTask/${id}`);
                // const res = await fetch(`http://192.168.110.111:8003/business/aiTask/1919949052468342786`);
                // const res = await fetch(`http://192.168.110.113:8003/business/aiTask/${id}`);
                const resJson = await res.json();
                console.log(resJson);
                
                const data = JSON.parse(resJson.data.taskMindXxcMap);

                if (!data) throw new Error("æ•°æ®ä¸ºç©º");

                const mind = {
                    meta: { name: "demo", author: "server", version: "1.0" },
                    format: "node_tree",
                    data: data
                };

                initMindMap(mind);
            } catch (err) {
                document.getElementById('loading').innerText = "âŒ æ•°æ®åŠ è½½å¤±è´¥";
                console.error("åŠ è½½å¤±è´¥", err);
            }
        }

        // **åˆå§‹åŒ–æ€ç»´å¯¼å›¾**
        function initMindMap(mind) {
            const options = { container: 'jsmind_container', editable: false, theme: 'primary' };
            jm = jsMind.show(options, mind);
            jm.view.setZoom(1);

            // **éšè— loading**
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
            }, 300);
        }

        document.addEventListener("DOMContentLoaded", function () {
            fetchMindData();

            // setTimeout(initMindMap, 500); // **ç­‰å¾… DOM åŠ è½½å®Œæˆååˆå§‹åŒ–**

            const container = document.getElementById("jsmind_container");
            const hammer = new Hammer(container);
            hammer.get("pinch").set({ enable: true });
            
            let startScale = 1; // è®°å½• pinch å¼€å§‹æ—¶çš„ scale

             // ç›‘å¬ pinchstart è®°å½•èµ·å§‹æ¯”ä¾‹
            hammer.on("pinchstart", function (e) {
                e.preventDefault();
                startScale = currentScale; // è®°å½• pinch å¼€å§‹çš„ç¼©æ”¾æ¯”ä¾‹
            });

            // **ç›‘å¬åŒæŒ‡ç¼©æ”¾**
            hammer.on("pinchmove", function (e) {
                e.preventDefault();
                if (!jm) return;

                let newScale = currentScale * e.scale;
                newScale = Math.max(minScale, Math.min(maxScale, newScale)); // é™åˆ¶ç¼©æ”¾èŒƒå›´

                console.log(`ğŸ” Scaling: ${currentScale} â†’ ${newScale}`);
                jm.view.setZoom(newScale);
            });

            // **æ›´æ–°å½“å‰ç¼©æ”¾æ¯”ä¾‹**
            hammer.on("pinchend", function (e) {
                e.preventDefault();
                if (!jm) return;
                currentScale *= e.scale;
                currentScale = Math.max(minScale, Math.min(maxScale, currentScale)); // ç¡®ä¿ scale åœ¨å…è®¸èŒƒå›´å†…
                console.log("ğŸ“Œ Pinch End: New Scale =", currentScale);
            });

            // **é˜²æ­¢ iOS Safari é»˜è®¤åŒæŒ‡ç¼©æ”¾**
            document.addEventListener('gesturestart', function (e) {
                e.preventDefault();
            });

            // **é˜»æ­¢ touchmove é€ æˆæ»šåŠ¨**
            document.addEventListener("touchmove", function (e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
        });
    </script>
</body>
</html>
